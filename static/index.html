<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Tramwaje Warszawskie | Paweł Przytuła</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
<script src="MovingMarker.js"></script>

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>

<body>
<div id="map"></div>
<script>
L.mapbox.accessToken = 'pk.eyJ1IjoicHJ6eXR1MSIsImEiOiJjaWtpOWFiM2EwMDM1dnBtNmIxZ25vN3UxIn0.7zanh1pEQeIXyPaiwxDuDg';

var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=' + L.mapbox.accessToken, {
    attribution: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});

var tramIcon = L.icon({
  iconUrl: 'tram.png',
  iconSize: [36, 45]
});

function swapLonLat(coords) {
  return [coords[1], coords[0]];
}

// http://leafletjs.com/examples/custom-icons.html

function addAnimatedMarker(map, lineCoords) {
  var line = L.polyline(lineCoords.map(swapLonLat));
  var animatedMarker = L.Marker.movingMarker(line.getLatLngs(), [50000], {
    icon: tramIcon,
    autostart: true
  });
  map.addLayer(animatedMarker);
}

function addMarker(map, pointCoords) {
  L.marker(swapLonLat(pointCoords), {
    icon: tramIcon
  }).addTo(map);
}

var map = L.map('map')
    .addLayer(mapboxTiles)
    .setView([52.237704, 20.983058], 12);

$.ajax({dataType: "json", url: "line-scheme",
  success: function(lineGeojson) {
    L.geoJson(lineGeojson).addTo(map);  
    setInterval(function () {
      $.ajax({dataType: "json", url: "positions",
        success: function(positions) {
          map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });
          if (positions.running !== null) {
            for (var i = 0; i < positions.running.features.length; i++) {
              addAnimatedMarker(map, positions.running.features[i].geometry.coordinates);
            }
          }
          if (positions.halted !== null) {
            for (var i = 0; i < positions.halted.features.length; i++) {
              addMarker(map, positions.halted.features[i].geometry.coordinates);
            }
          }
        }
      }).error(function() {});
    }, 30000);
  }
}).error(function() {});
</script>
</body>
</html>